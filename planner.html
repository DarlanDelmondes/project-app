<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tree Milestones ‚Äî LocalStorage</title>
  <style>
    :root{
      --bg:#0b0f19; --panel:#111a2e; --panel2:#0f1627; --text:#e8eefc;
      --muted:#9db0d1; --line:#243252; --accent:#7aa2ff; --danger:#ff6b6b; --ok:#55e6a5;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
    }
    [data-theme="light"]{
      --bg:#f6f7fb; --panel:#ffffff; --panel2:#f3f5fb; --text:#0b1220;
      --muted:#4b5b78; --line:#d6deee; --accent:#2b62ff; --danger:#d93a3a; --ok:#0a8f5a;
      --shadow: 0 10px 30px rgba(14, 24, 40, .10);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 800px at 30% -10%, rgba(122,162,255,.22), transparent 60%),
                  radial-gradient(900px 600px at 110% 10%, rgba(85,230,165,.16), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    [data-theme="light"] body{
      background: radial-gradient(1200px 800px at 30% -10%, rgba(43,98,255,.14), transparent 60%),
                  radial-gradient(900px 600px at 110% 10%, rgba(10,143,90,.10), transparent 55%),
                  var(--bg);
    }
    header{
      position:sticky; top:0; z-index:10;
      background: color-mix(in srgb, var(--bg) 75%, transparent);
      backdrop-filter: blur(10px);
      border-bottom:1px solid color-mix(in srgb, var(--line) 65%, transparent);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:12px 14px 14px}
    .topbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .title{font-weight:850; letter-spacing:.2px; font-size:16px}
    .sub{color:var(--muted); font-size:11px}
    .spacer{flex:1}
    .btn{
      border:1px solid color-mix(in srgb, var(--accent) 40%, transparent);
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 14%, transparent), color-mix(in srgb, var(--accent) 6%, transparent));
      color:var(--text);
      padding:8px 10px;
      border-radius:11px;
      cursor:pointer;
      display:inline-flex; gap:8px; align-items:center;
      box-shadow: 0 8px 18px color-mix(in srgb, #000 22%, transparent);
      user-select:none;
      font-size:12px;
    }
    [data-theme="light"] .btn{ box-shadow: 0 8px 18px rgba(14,24,40,.10); }
    .btn:hover{border-color: color-mix(in srgb, var(--accent) 55%, transparent)}
    .btn.ghost{ background:transparent; border-color: color-mix(in srgb, var(--muted) 25%, transparent); box-shadow:none; }
    .btn.ok{border-color: color-mix(in srgb, var(--ok) 55%, transparent); background: color-mix(in srgb, var(--ok) 10%, transparent)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid color-mix(in srgb, var(--muted) 22%, transparent);
      padding:6px 9px; border-radius:999px; color:var(--muted); font-size:11px;
      background: color-mix(in srgb, var(--panel) 35%, transparent);
    }
    .pill input{accent-color: var(--accent)}
    .status{
      font-size:11px;
      color:var(--muted);
      border:1px solid color-mix(in srgb, var(--muted) 22%, transparent);
      background: color-mix(in srgb, var(--panel) 30%, transparent);
      padding:6px 9px;
      border-radius:999px;
      display:inline-flex; gap:8px; align-items:center;
      user-select:none;
    }
    .status.ok{border-color: color-mix(in srgb, var(--ok) 55%, transparent); color: color-mix(in srgb, var(--ok) 30%, var(--text));}
    .status.bad{border-color: color-mix(in srgb, var(--danger) 60%, transparent); color: color-mix(in srgb, var(--danger) 30%, var(--text));}

    main{max-width:1100px; margin:0 auto; padding:12px 14px 34px}
    .card{
      background: linear-gradient(180deg, color-mix(in srgb, var(--panel) 92%, transparent), color-mix(in srgb, var(--panel2) 92%, transparent));
      border:1px solid color-mix(in srgb, var(--line) 70%, transparent);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-head{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-bottom:1px solid color-mix(in srgb, var(--line) 55%, transparent);
    }
    .hint{color:var(--muted); font-size:11px; line-height:1.35}
    .content{padding:10px}
    .empty{
      padding:14px; border:1px dashed color-mix(in srgb, var(--muted) 28%, transparent); border-radius:12px;
      color:var(--muted); background: color-mix(in srgb, var(--panel2) 45%, transparent);
      font-size:12px;
    }

    .tree{display:flex; flex-direction:column; gap:6px}
    .row{
      position:relative;
      border:1px solid color-mix(in srgb, var(--line) 70%, transparent);
      background: color-mix(in srgb, var(--panel2) 52%, transparent);
      border-radius:12px;
      overflow:hidden;
    }
    .row.dragging{opacity:.55}
    .row-head{ display:flex; align-items:center; gap:8px; padding:6px 8px; }
    .indent{display:inline-flex; align-items:center; gap:0}
    .indent .pad{width:14px; height:1px}
    .handle{
      width:22px; height:22px; border-radius:8px; display:grid; place-items:center;
      border:1px solid color-mix(in srgb, var(--muted) 22%, transparent);
      background: color-mix(in srgb, var(--panel) 55%, transparent);
      cursor:grab; user-select:none; font-size:12px; line-height:1;
    }
    .handle:active{cursor:grabbing}
    .iconBtn{
      width:24px; height:24px; border-radius:8px;
      border:1px solid color-mix(in srgb, var(--muted) 22%, transparent);
      background: color-mix(in srgb, var(--panel) 42%, transparent);
      color:var(--text);
      cursor:pointer;
      display:grid; place-items:center;
      user-select:none;
      font-size:12px; line-height:1;
    }
    .iconBtn:hover{border-color: color-mix(in srgb, var(--accent) 55%, transparent)}
    .iconBtn.ok{
      border-color: color-mix(in srgb, var(--ok) 60%, transparent) !important;
      background: color-mix(in srgb, var(--ok) 14%, transparent) !important;
    }

    .titleInput{
      flex:1; min-width:120px;
      border-radius:9px;
      border:1px solid color-mix(in srgb, var(--line) 85%, transparent);
      background: color-mix(in srgb, var(--bg) 22%, transparent);
      color:var(--text);
      padding:5px 8px;
      outline:none;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .titleInput:focus{border-color: color-mix(in srgb, var(--accent) 70%, transparent)}
    .badges{display:flex; gap:6px; align-items:center; flex-wrap:wrap}
    .badge{
      font-size:10px; padding:3px 7px; border-radius:999px;
      border:1px solid color-mix(in srgb, var(--muted) 22%, transparent);
      color:var(--muted);
      background: color-mix(in srgb, var(--panel) 35%, transparent);
      display:inline-flex; gap:6px; align-items:center;
      user-select:none;
    }
    .badge.danger{border-color: color-mix(in srgb, var(--danger) 60%, transparent); color: color-mix(in srgb, var(--danger) 20%, var(--text)); background: color-mix(in srgb, var(--danger) 12%, transparent)}
    .badge.ok{border-color: color-mix(in srgb, var(--ok) 60%, transparent); color: color-mix(in srgb, var(--ok) 20%, var(--text)); background: color-mix(in srgb, var(--ok) 10%, transparent)}

    /* ---- Actions bar (agora por duplo clique) ---- */
    .actionsBar{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 8px;
      border-top:1px solid color-mix(in srgb, var(--line) 55%, transparent);
      background: color-mix(in srgb, var(--bg) 10%, transparent);

      opacity:0;
      max-height:0;
      overflow:hidden;
      transition: opacity .12s ease, max-height .12s ease;
      pointer-events:none;
    }
    .row.actionsOpen .actionsBar{
      opacity:1;
      max-height:60px;
      pointer-events:auto;
    }
    .actionsBar .spacer{flex:1}

    .editOnly{display:none;}
    .editMode .editOnly{display:inline-grid;} /* iconBtn */
    .editMode .editOnly.inline{display:inline-flex;} /* badges/inputs */

    .row-body{
      padding:8px 8px 10px;
      border-top:1px solid color-mix(in srgb, var(--line) 55%, transparent);
      background: color-mix(in srgb, var(--bg) 12%, transparent);
    }
    .grid{display:grid; grid-template-columns: 1.2fr .8fr .8fr; gap:8px;}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
    .panel{
      border:1px solid color-mix(in srgb, var(--line) 70%, transparent);
      background: color-mix(in srgb, var(--panel2) 50%, transparent);
      border-radius:12px;
      padding:8px;
    }
    .panel h4{margin:0 0 6px; font-size:12px; letter-spacing:.2px; display:flex; align-items:center; gap:8px;}
    .panel small{color:var(--muted)}
    textarea{
      width:100%; min-height:90px; resize:vertical;
      border-radius:10px;
      border:1px solid color-mix(in srgb, var(--line) 85%, transparent);
      background: color-mix(in srgb, var(--bg) 22%, transparent);
      color:var(--text);
      padding:8px; outline:none; font-size:12px;
    }
    textarea:focus{border-color: color-mix(in srgb, var(--accent) 70%, transparent)}
    .miniRow{display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap}
    .miniRow input[type="text"], .miniRow input[type="url"]{
      flex:1; min-width:160px;
      border-radius:10px;
      border:1px solid color-mix(in srgb, var(--line) 85%, transparent);
      background: color-mix(in srgb, var(--bg) 22%, transparent);
      color:var(--text);
      padding:7px 8px; outline:none; font-size:12px;
    }
    .miniRow input:focus{border-color: color-mix(in srgb, var(--accent) 70%, transparent)}
    .list{display:flex; flex-direction:column; gap:6px; margin-top:8px}
    .itemLine{
      display:flex; gap:8px; align-items:center;
      padding:7px;
      border-radius:10px;
      border:1px solid color-mix(in srgb, var(--line) 70%, transparent);
      background: color-mix(in srgb, var(--panel) 35%, transparent);
      font-size:12px;
    }
    .itemLine a{color: color-mix(in srgb, var(--accent) 55%, var(--text)); text-decoration:none}
    .itemLine a:hover{text-decoration:underline}
    .muted{color:var(--muted)}
    .right{margin-left:auto; display:flex; gap:6px}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 9px; border-radius:12px;
      border:1px solid color-mix(in srgb, var(--line) 70%, transparent);
      background: color-mix(in srgb, var(--panel) 25%, transparent);
      font-size:12px;
    }
    .dropZone{height:8px;border-radius:999px;background:transparent;margin:4px 8px}
    .dropZone.active{
      background: color-mix(in srgb, var(--accent) 35%, transparent);
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent) 12%, transparent);
    }
    .k{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace}
    .dots{display:inline-flex; gap:3px; align-items:center}
    .dot{
      width:6px; height:6px; border-radius:999px;
      background: color-mix(in srgb, var(--muted) 45%, transparent);
      border:1px solid color-mix(in srgb, var(--muted) 25%, transparent);
      opacity:.9;
    }
    .dot.hot{ background: color-mix(in srgb, var(--danger) 55%, transparent); border-color: color-mix(in srgb, var(--danger) 35%, transparent); }
    .dot.fresh{ background: color-mix(in srgb, var(--ok) 40%, transparent); border-color: color-mix(in srgb, var(--ok) 25%, transparent); }
    .dotLabel{font-size:10px;color:var(--muted);margin-left:6px}

    .sectionTitle{
      font-size:12px; font-weight:800; letter-spacing:.2px;
      color: color-mix(in srgb, var(--text) 92%, var(--muted));
      padding:10px 12px;
      border-bottom:1px solid color-mix(in srgb, var(--line) 55%, transparent);
      display:flex; align-items:center; gap:8px;
      user-select:none;
      cursor:pointer;
    }
    .sectionTitle .muted{cursor:default;}
    .sectionTitle .spacer{cursor:default;}
    .collapsedContent{display:none;}
    .card.open .collapsedContent{display:block;}

    .completedList{padding:10px; display:flex; flex-direction:column; gap:6px}
    .cRow{
      border:1px solid color-mix(in srgb, var(--line) 70%, transparent);
      background: color-mix(in srgb, var(--panel2) 45%, transparent);
      border-radius:12px;
      padding:6px 8px;
      display:flex; gap:8px; align-items:center;
      font-size:12px;
      opacity:.95;
    }
    .cTitle{font-weight:800}
    .cMeta{color:var(--muted); font-size:11px}

    .row.done .titleInput{ text-decoration: line-through; opacity: .62; }
    .row.done{opacity:.92}

    .archiveBox{
      margin:6px 8px 8px;
      border:1px solid color-mix(in srgb, var(--line) 65%, transparent);
      border-radius:12px;
      background: color-mix(in srgb, var(--panel) 18%, transparent);
      overflow:hidden;
    }
    .archiveHdr{
      display:flex; align-items:center; gap:8px;
      padding:6px 8px;
      cursor:pointer;
      color:var(--muted);
      font-size:11px;
      user-select:none;
    }
    .archiveList{ padding:6px 8px 8px; display:flex; flex-direction:column; gap:6px; }

    /* ---- N√≠veis (1..5) painel ---- */
    .levelGrid{ display:grid; grid-template-columns: repeat(5, minmax(120px, 1fr)); gap:10px; }
    @media (max-width: 900px){ .levelGrid{ grid-template-columns:1fr; } }
    .levelBox{
      border:1px solid color-mix(in srgb, var(--line) 70%, transparent);
      background: color-mix(in srgb, var(--panel2) 45%, transparent);
      border-radius:12px;
      padding:10px;
    }
    .levelBox h5{ margin:0 0 8px; font-size:12px; }
    .levelRow{ display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .levelRow input[type="number"]{
      width:80px; border-radius:10px;
      border:1px solid color-mix(in srgb, var(--line) 85%, transparent);
      background: color-mix(in srgb, var(--bg) 22%, transparent);
      color:var(--text);
      padding:7px 8px; outline:none; font-size:12px;
    }
    .levelRow label{ display:inline-flex; gap:6px; align-items:center; color:var(--muted); font-size:11px; }

    /* ---- Top Pessoas ---- */
    .pTopWrap{ width:100%; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .pChip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 9px; border-radius:999px;
      border:1px solid color-mix(in srgb, var(--line) 70%, transparent);
      background: color-mix(in srgb, var(--panel) 25%, transparent);
      color: var(--text);
      cursor:pointer; user-select:none; font-size:11px;
    }
    .pChip:hover{ border-color: color-mix(in srgb, var(--accent) 60%, transparent); }
    .pChip.active{
      border-color: color-mix(in srgb, var(--accent) 75%, transparent);
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent) 12%, transparent);
    }
    .pPanel{
      width:100%;
      border:1px solid color-mix(in srgb, var(--line) 70%, transparent);
      background: color-mix(in srgb, var(--panel2) 45%, transparent);
      border-radius:12px;
      padding:10px;
    }
    .pPanelHead{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:8px; }
    .pPanelTitle{ font-weight:850; font-size:12px; letter-spacing:.2px; }
    .pPanelHint{ color: var(--muted); font-size:11px; }
    .pGrid{ display:grid; grid-template-columns: repeat(3, minmax(220px, 1fr)); gap:10px; }
    @media (max-width: 900px){ .pGrid{ grid-template-columns:1fr; } }
    .pCard{
      border:1px solid color-mix(in srgb, var(--line) 70%, transparent);
      background: color-mix(in srgb, var(--panel) 30%, transparent);
      border-radius:12px;
      padding:10px;
      overflow:hidden;
    }
    .pName{ display:flex; align-items:center; gap:8px; font-weight:850; font-size:12px; margin-bottom:6px; }
    .pList{ display:flex; flex-direction:column; gap:6px; margin-top:6px; }
    .pItem{
      display:flex; gap:8px; align-items:center;
      padding:6px 8px; border-radius:10px;
      border:1px solid color-mix(in srgb, var(--line) 65%, transparent);
      background: color-mix(in srgb, var(--bg) 10%, transparent);
      cursor:pointer; font-size:11px;
    }
    .pItem:hover{ border-color: color-mix(in srgb, var(--accent) 55%, transparent); }
    .pMeta{ color: var(--muted); font-size:10px; margin-left:auto; white-space:nowrap; }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="title">Tree Milestones (LocalStorage)</div>
        <div class="sub">Salvar no dispositivo via LocalStorage ‚Ä¢ Backup/Import</div>
      </div>
      <div class="spacer"></div>

      <span id="saveStatus" class="status">üíæ Carregando‚Ä¶</span>
      <button class="btn ok" id="saveBtn" title="Salvar agora no LocalStorage">üíæ Salvar agora</button>

      <label class="pill" title="Mostra apenas milestones (mantendo os ancestrais para contexto)">
        <input id="filterMilestones" type="checkbox" />
        S√≥ milestones
      </label>

      <label class="pill" title="Alterna entre Visualiza√ß√£o e Edi√ß√£o">
        <input id="editModeToggle" type="checkbox" />
        Modo edi√ß√£o
      </label>

      <button class="btn ghost" id="themeBtn" title="Alternar tema">üåô Noite</button>

      <button class="btn ok" id="addRootBtn">‚ûï Item</button>
      <button class="btn ghost" id="backupBtn">üì§ Backup</button>
      <button class="btn ghost" id="importBtn">üì• Import</button>
      <input id="importFile" type="file" accept="application/json" hidden />
    </div>
  </div>
</header>

<main>

  <div class="card" id="levelCard">
    <div class="sectionTitle" id="levelTitle">
      <span id="levelChevron">‚ñ∏</span> üéõ Apar√™ncia por n√≠vel (1‚Äì5)
      <div class="spacer"></div>
      <span class="muted" style="font-size:11px;">duplo clique nos itens abre a√ß√µes</span>
    </div>
    <div class="collapsedContent">
      <div class="content" id="levelStylePanel"></div>
    </div>
  </div>

  <div style="height:10px"></div>

  <div class="card">
    <div class="card-head">
      <div class="hint">
        <div><span class="k">Drag</span>: ‚ãÆ‚ãÆ ‚Ä¢ <span class="k">Drop</span>: em cima=filho, barra=irm√£o ‚Ä¢ ‚ñ∂Ô∏é/‚óÄÔ∏é indent/outdent</div>
      </div>
      <div class="spacer"></div>
      <div class="chip" title="Contagem atual">
        üìå <span id="countItems">0</span> ‚Ä¢ ‚úÖ <span id="countDone">0</span> ‚Ä¢ ‚è≥ <span id="countOverdue">0</span>
      </div>
    </div>
    <div class="content">
      <div id="tree" class="tree"></div>
    </div>
  </div>

  <div style="height:10px"></div>

  <div class="card">
    <div class="sectionTitle">‚úÖ Conclu√≠dos <span class="muted" id="doneHint"></span></div>
    <div class="completedList" id="completed"></div>
  </div>
</main>

<script>
(() => {
  const LS_KEY = "planner-completo";

  // ---- time helpers ----
  const nowISO = () => new Date().toISOString();
  const dayStart = (d) => { const x = new Date(d); x.setHours(0,0,0,0); return x; };
  const daysBetween = (aISO, bISO) => Math.max(0, Math.floor((dayStart(bISO) - dayStart(aISO)) / (24*60*60*1000)));
  const formatDate = (iso) => {
    if (!iso) return "";
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return "";
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = String(d.getFullYear());
    return `${dd}/${mm}/${yy}`;
  };
  const uid = () => Math.random().toString(36).slice(2,10) + "-" + Date.now().toString(36);

  // ---- UI refs ----
  const saveStatus = document.getElementById("saveStatus");
  const saveBtn = document.getElementById("saveBtn");
  const themeBtn = document.getElementById("themeBtn");
  const elTree = document.getElementById("tree");
  const elCompleted = document.getElementById("completed");
  const elDoneHint = document.getElementById("doneHint");
  const elFilter = document.getElementById("filterMilestones");
  const elEditMode = document.getElementById("editModeToggle");
  const elLevelStylePanel = document.getElementById("levelStylePanel");
  const elCountItems = document.getElementById("countItems");
  const elCountOverdue = document.getElementById("countOverdue");
  const elCountDone = document.getElementById("countDone");

  const levelCard = document.getElementById("levelCard");
  const levelTitle = document.getElementById("levelTitle");
  const levelChevron = document.getElementById("levelChevron");

  // ---- defaults ----
  function defaultLevelStyles(){
    return {
      1: { size: 14, bold: true,  italic: false },
      2: { size: 13, bold: true,  italic: false },
      3: { size: 12, bold: false, italic: false },
      4: { size: 12, bold: false, italic: true  },
      5: { size: 11, bold: false, italic: true  },
    };
  }
  function levelFromDepth(depth){ return Math.min(5, Math.max(1, depth + 1)); }
  function applyTitleStyleByDepth(inputEl, depth){
    const lvl = levelFromDepth(depth);
    const st = state.ui.levelStyles?.[lvl] || defaultLevelStyles()[lvl];
    inputEl.style.fontSize = (st.size || 12) + "px";
    inputEl.style.fontWeight = st.bold ? "850" : "600";
    inputEl.style.fontStyle = st.italic ? "italic" : "normal";
  }

  // ---- storage ----
  function storageWritable(){
    try{
      const k = "__ls_test__" + Math.random().toString(36).slice(2);
      localStorage.setItem(k, "1");
      localStorage.removeItem(k);
      return true;
    }catch(e){
      console.error("LocalStorage n√£o grav√°vel:", e);
      return false;
    }
  }
  const lsOk = storageWritable();

  function setStatus(kind, text){
    saveStatus.classList.remove("ok","bad");
    if (kind) saveStatus.classList.add(kind);
    saveStatus.textContent = text;
  }

  let dirty = false;
  function markDirty(){
    dirty = true;
    setStatus("", "üü° Altera√ß√µes pendentes");
  }

  function forceSave(){
    if (!lsOk){
      setStatus("bad", "‚õî LocalStorage bloqueado");
      return false;
    }
    try{
      const payload = JSON.stringify(state);
      localStorage.setItem(LS_KEY, payload);
      dirty = false;
      setStatus("ok", "‚úÖ Salvo no dispositivo");
      updateCounters();
      return true;
    }catch(e){
      console.error("Erro ao salvar:", e);
      setStatus("bad", "‚õî Erro ao salvar");
      alert("Falha ao salvar no LocalStorage. Abra o console (F12) para ver o erro.");
      return false;
    }
  }

  function autoSaveIfDirty(){ if (dirty) forceSave(); }
  window.addEventListener("beforeunload", autoSaveIfDirty);
  document.addEventListener("visibilitychange", ()=> {
    if (document.visibilityState === "hidden") autoSaveIfDirty();
  });
  setInterval(autoSaveIfDirty, 2500);
  saveBtn.addEventListener("click", ()=> forceSave());

  // ---- load ----
  function loadState(){
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) {
      return {
        items: [],
        ui: {
          filterMilestones:false,
          theme:'dark',
          editMode:false,
          levelStyles: defaultLevelStyles(),
          levelPanelOpen:false,              // ‚úÖ colapsado por padr√£o
          peopleTop:{ open:true, active:"" }
        }
      };
    }
    try{
      const parsed = JSON.parse(raw);
      if (!parsed || !Array.isArray(parsed.items)) throw new Error("invalid");

      parsed.ui ||= {};
      if (typeof parsed.ui.filterMilestones !== "boolean") parsed.ui.filterMilestones = false;
      if (!parsed.ui.theme) parsed.ui.theme = "dark";
      if (typeof parsed.ui.editMode !== "boolean") parsed.ui.editMode = false;
      parsed.ui.levelStyles ||= defaultLevelStyles();
      if (typeof parsed.ui.levelPanelOpen !== "boolean") parsed.ui.levelPanelOpen = false;
      parsed.ui.peopleTop ||= { open:true, active:"" };

      const t = nowISO();
      for (const it of parsed.items){
        it.createdAt ||= t;
        it.updatedAt ||= it.createdAt;
        it.completedAt ||= null;

        if (typeof it.detailsOpen !== "boolean") it.detailsOpen = false;
        if (typeof it.expanded !== "boolean") it.expanded = false;
        if (typeof it.actionsOpen !== "boolean") it.actionsOpen = false; // ‚úÖ actions por duplo clique

        it.archived = !!it.archived;
        if (typeof it.archiveOpen !== "boolean") it.archiveOpen = false;

        it.links ||= [];
        it.people ||= [];
        it.notes ||= "";
        it.milestone ||= { enabled:false, date:"" };
        it.milestone.enabled = !!it.milestone.enabled;
        it.milestone.date ||= "";

        it.completed = !!it.completed;
      }
      return parsed;
    }catch(e){
      console.error("Storage inv√°lido/corrompido:", e);
      setStatus("bad", "‚õî Storage inv√°lido");
      return {
        items: [],
        ui: {
          filterMilestones:false, theme:'dark', editMode:false,
          levelStyles: defaultLevelStyles(),
          levelPanelOpen:false,
          peopleTop:{ open:true, active:"" }
        }
      };
    }
  }

  let state = loadState();

  // ---- collapsible level panel ----
  function applyLevelPanelUI(){
    levelCard.classList.toggle("open", !!state.ui.levelPanelOpen);
    levelChevron.textContent = state.ui.levelPanelOpen ? "‚ñæ" : "‚ñ∏";
  }
  levelTitle.addEventListener("click", (e)=> {
    // permite selecionar o hint sem toggle (se quiser)
    state.ui.levelPanelOpen = !state.ui.levelPanelOpen;
    markDirty();
    applyLevelPanelUI();
    if (state.ui.levelPanelOpen) renderLevelStylePanel();
  });

  // ---- domain helpers ----
  function getItem(id){ return state.items.find(x => x.id === id); }
  function childrenOf(parentId){
    return state.items.filter(x => x.parentId === parentId).sort((a,b)=> (a.order ?? 0) - (b.order ?? 0));
  }
  function siblingsOf(item){ return childrenOf(item.parentId); }
  function nextOrder(parentId){
    const kids = childrenOf(parentId);
    return kids.length ? (kids[kids.length-1].order + 1) : 0;
  }
  function normalizeOrders(parentId){
    const kids = childrenOf(parentId);
    kids.forEach((k,idx)=> k.order = idx);
  }
  function subtreeIds(rootId){
    const ids = [];
    const stack = [rootId];
    while(stack.length){
      const id = stack.pop();
      ids.push(id);
      const kids = childrenOf(id);
      for (let i = kids.length-1; i>=0; i--) stack.push(kids[i].id);
    }
    return ids;
  }
  function collapseSubtree(rootId){
    for (const id of subtreeIds(rootId)){
      const it = getItem(id);
      if (it){
        it.expanded = false;
        it.actionsOpen = false; // ‚úÖ fecha a√ß√µes tamb√©m
      }
    }
  }
  function wouldCreateCycle(dragId, newParentId){
    if (newParentId == null) return false;
    if (dragId === newParentId) return true;
    return new Set(subtreeIds(dragId)).has(newParentId);
  }
  function touchItem(item){ item.updatedAt = nowISO(); }

  // ---- milestone / overdue ----
  const todayISO = () => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  };
  const isOverdue = (item) => {
    if (!item.milestone?.enabled) return false;
    if (item.completed) return false;
    const dt = item.milestone.date;
    if (!dt) return false;
    return dt < todayISO();
  };

  // ---- theme ----
  function applyTheme(){
    document.documentElement.setAttribute("data-theme", state.ui.theme === 'light' ? 'light' : 'dark');
    themeBtn.textContent = state.ui.theme === 'light' ? "‚òÄÔ∏è Dia" : "üåô Noite";
  }
  themeBtn.addEventListener("click", ()=> {
    state.ui.theme = (state.ui.theme === 'light') ? 'dark' : 'light';
    markDirty();
    applyTheme();
  });

  // ---- edit mode ----
  elEditMode.addEventListener("change", ()=> {
    state.ui.editMode = elEditMode.checked;
    markDirty();
    render();
  });

  // ---- filter milestones ----
  elFilter.addEventListener("change", ()=> {
    state.ui.filterMilestones = elFilter.checked;
    markDirty();
    render();
  });

  // ---- rendering helpers ----
  function visibleSet(){
    if (!state.ui.filterMilestones) return null;
    const visible = new Set();
    const milestones = state.items.filter(i => i.milestone?.enabled);
    for (const m of milestones){
      visible.add(m.id);
      let p = m.parentId;
      while(p){
        visible.add(p);
        p = getItem(p)?.parentId ?? null;
      }
    }
    return visible;
  }
  function depthOf(item){
    let d = 0;
    let p = item.parentId;
    while(p){
      d++;
      p = getItem(p)?.parentId ?? null;
      if (d > 60) break;
    }
    return d;
  }
  function stalenessDays(item){ return daysBetween(item.updatedAt || item.createdAt, nowISO()); }
  function stalenessDots(days){
    const wrap = document.createElement("span");
    wrap.className = "dots";
    const maxDots = 10;
    const count = Math.min(days, maxDots);
    for (let i=0;i<count;i++){
      const dot = document.createElement("span");
      dot.className = "dot";
      if (days <= 1) dot.classList.add("fresh");
      else if (days >= 5) dot.classList.add("hot");
      wrap.appendChild(dot);
    }
    const label = document.createElement("span");
    label.className = "dotLabel";
    label.textContent = days === 0 ? "0d" : `${days}d`;
    wrap.appendChild(label);
    return wrap;
  }
  function itemHasNotesOrLinks(item){
    return (!!(item.notes || "").trim()) || ((item.links || []).length > 0);
  }

  // ---- level style panel ----
  function renderLevelStylePanel(){
    elLevelStylePanel.innerHTML = "";

    const grid = document.createElement("div");
    grid.className = "levelGrid";

    for (let lvl=1; lvl<=5; lvl++){
      const st = state.ui.levelStyles[lvl] || (state.ui.levelStyles[lvl] = defaultLevelStyles()[lvl]);

      const box = document.createElement("div");
      box.className = "levelBox";
      box.innerHTML = `<h5>N√≠vel ${lvl}</h5>`;

      const row1 = document.createElement("div");
      row1.className = "levelRow";

      const size = document.createElement("input");
      size.type = "number";
      size.min = "10";
      size.max = "28";
      size.value = st.size;
      size.title = "Tamanho da fonte (px)";
      size.addEventListener("input", ()=> {
        st.size = Number(size.value || 12);
        markDirty();
        render();
      });

      const bold = document.createElement("label");
      const bchk = document.createElement("input");
      bchk.type = "checkbox";
      bchk.checked = !!st.bold;
      bchk.addEventListener("change", ()=> {
        st.bold = bchk.checked;
        markDirty();
        render();
      });
      bold.appendChild(bchk);
      bold.appendChild(document.createTextNode("Negrito"));

      const italic = document.createElement("label");
      const ichk = document.createElement("input");
      ichk.type = "checkbox";
      ichk.checked = !!st.italic;
      ichk.addEventListener("change", ()=> {
        st.italic = ichk.checked;
        markDirty();
        render();
      });
      italic.appendChild(ichk);
      italic.appendChild(document.createTextNode("It√°lico"));

      row1.appendChild(document.createTextNode("Fonte:"));
      row1.appendChild(size);
      row1.appendChild(bold);
      row1.appendChild(italic);

      box.appendChild(row1);
      grid.appendChild(box);
    }

    elLevelStylePanel.appendChild(grid);
  }

  // ---- top people ----
  function ensurePeopleTopUI(){
    let host = document.getElementById("peopleTopHost");
    if (!host) {
      const topbar = document.querySelector(".topbar");
      if (!topbar) return;
      host = document.createElement("div");
      host.id = "peopleTopHost";
      host.style.display = "flex";
      host.style.flexWrap = "wrap";
      host.style.gap = "8px";
      host.style.alignItems = "center";
      host.style.width = "100%";
      host.style.marginTop = "8px";
      topbar.appendChild(host);
    }
  }
  function buildPeopleIndex(){
    const map = new Map();
    for (const it of state.items){
      if (it.archived) continue;
      for (const p of (it.people || [])){
        const name = String(p?.name || "").trim();
        if (!name) continue;
        const key = name.toLowerCase();
        if (!map.has(key)) map.set(key, { nameOriginal: name, items: [] });
        map.get(key).items.push(it);
      }
    }
    const idx = [...map.values()].map(g => {
      g.items = g.items.slice().sort((a,b)=>{
        const oa = isOverdue(a) ? 1 : 0;
        const ob = isOverdue(b) ? 1 : 0;
        if (oa !== ob) return ob - oa;
        const da = a.milestone?.date || "9999-99-99";
        const db = b.milestone?.date || "9999-99-99";
        if (da !== db) return da.localeCompare(db);
        const ta = new Date(a.updatedAt || a.createdAt || 0).getTime();
        const tb = new Date(b.updatedAt || b.createdAt || 0).getTime();
        return tb - ta;
      });
      return g;
    });
    idx.sort((a,b)=> (b.items.length - a.items.length) || a.nameOriginal.localeCompare(b.nameOriginal));
    return idx;
  }
  function scrollToItem(id){
    const row = document.querySelector(`.row[data-id="${CSS.escape(id)}"]`);
    if (!row) return;
    row.scrollIntoView({ behavior: "smooth", block: "center" });
    row.style.boxShadow = "0 0 0 4px color-mix(in srgb, var(--accent) 18%, transparent)";
    setTimeout(()=> { row.style.boxShadow = ""; }, 900);
  }
  function renderPeopleTop(){
    ensurePeopleTopUI();
    const host = document.getElementById("peopleTopHost");
    if (!host) return;
    host.innerHTML = "";

    const wrap = document.createElement("div");
    wrap.className = "pTopWrap";

    const idx = buildPeopleIndex();
    if (!idx.length){
      const small = document.createElement("div");
      small.className = "pill";
      small.textContent = "üë• Pessoas: (0)";
      wrap.appendChild(small);
      host.appendChild(wrap);
      return;
    }

    const toggle = document.createElement("div");
    toggle.className = "pChip";
    toggle.textContent = state.ui.peopleTop.open ? "üë• Pessoas ‚ñæ" : "üë• Pessoas ‚ñ∏";
    toggle.title = "Abrir/fechar painel de pessoas";
    toggle.addEventListener("click", ()=> {
      state.ui.peopleTop.open = !state.ui.peopleTop.open;
      markDirty();
      render();
    });
    wrap.appendChild(toggle);

    const maxChips = 10;
    const shown = idx.slice(0, maxChips);
    for (const g of shown){
      const chip = document.createElement("div");
      chip.className = "pChip" + ((state.ui.peopleTop.active || "") === g.nameOriginal ? " active" : "");
      chip.textContent = `üë§ ${g.nameOriginal} ‚Ä¢ ${g.items.length}`;
      chip.addEventListener("click", ()=> {
        const cur = state.ui.peopleTop.active || "";
        state.ui.peopleTop.active = (cur === g.nameOriginal) ? "" : g.nameOriginal;
        markDirty();
        render();
      });
      wrap.appendChild(chip);
    }
    if (idx.length > maxChips){
      const more = document.createElement("div");
      more.className = "pChip";
      more.textContent = `+${idx.length - maxChips}‚Ä¶`;
      more.addEventListener("click", ()=> {
        state.ui.peopleTop.open = true;
        markDirty();
        render();
      });
      wrap.appendChild(more);
    }

    host.appendChild(wrap);

    if (!state.ui.peopleTop.open) return;

    const panel = document.createElement("div");
    panel.className = "pPanel";

    const head = document.createElement("div");
    head.className = "pPanelHead";

    const ttl = document.createElement("div");
    ttl.className = "pPanelTitle";
    ttl.textContent = "Assuntos por pessoa";

    const hint = document.createElement("div");
    hint.className = "pPanelHint";
    hint.textContent = "Clique em um assunto para navegar at√© ele na √°rvore.";

    const clear = document.createElement("button");
    clear.className = "btn ghost";
    clear.style.padding = "7px 9px";
    clear.style.borderRadius = "10px";
    clear.textContent = "Limpar foco";
    clear.addEventListener("click", ()=> {
      state.ui.peopleTop.active = "";
      markDirty();
      render();
    });

    head.appendChild(ttl);
    head.appendChild(hint);
    head.appendChild(clear);
    panel.appendChild(head);

    const grid = document.createElement("div");
    grid.className = "pGrid";

    const active = (state.ui.peopleTop.active || "").trim();
    const groupsToShow = active ? idx.filter(g => g.nameOriginal === active) : idx;

    for (const g of groupsToShow){
      const card = document.createElement("div");
      card.className = "pCard";

      const nm = document.createElement("div");
      nm.className = "pName";
      nm.textContent = `üë§ ${g.nameOriginal} (${g.items.length})`;

      const list = document.createElement("div");
      list.className = "pList";

      const maxItems = 12;
      const slice = g.items.slice(0, maxItems);

      for (const it of slice){
        const line = document.createElement("div");
        line.className = "pItem";

        const t = document.createElement("div");
        t.textContent = it.title?.trim() ? it.title.trim() : "(sem t√≠tulo)";

        const meta = document.createElement("div");
        meta.className = "pMeta";
        const dt = it.milestone?.enabled ? (it.milestone.date || "") : "";
        const overdue = isOverdue(it) ? "‚ö†" : "";
        meta.textContent = dt ? `${overdue} üìÖ ${dt}` : (overdue ? "‚ö† atrasado" : "");

        line.appendChild(t);
        line.appendChild(meta);

        line.addEventListener("click", ()=> {
          let p = it.parentId;
          while(p){
            const par = getItem(p);
            if (!par) break;
            par.expanded = true;
            p = par.parentId;
          }
          it.archived = false;
          markDirty();
          render();
          setTimeout(()=> scrollToItem(it.id), 80);
        });

        list.appendChild(line);
      }

      if (g.items.length > maxItems){
        const more = document.createElement("div");
        more.className = "pPanelHint";
        more.textContent = `‚Ä¶ +${g.items.length - maxItems} assuntos`;
        more.style.marginTop = "6px";
        list.appendChild(more);
      }

      card.appendChild(nm);
      card.appendChild(list);
      grid.appendChild(card);
    }

    panel.appendChild(grid);
    host.appendChild(panel);
  }

  // ---- notes debounce (sem render para evitar desfoco) ----
  const noteTimers = new Map();
  function scheduleNoteTouch(item){
    if (noteTimers.has(item.id)) clearTimeout(noteTimers.get(item.id));
    const t = setTimeout(()=> {
      touchItem(item);
      markDirty();
      updateCounters();
    }, 450);
    noteTimers.set(item.id, t);
  }

  // ---- render ----
  function render(){
    document.body.classList.toggle("editMode", !!state.ui.editMode);

    elFilter.checked = !!state.ui.filterMilestones;
    elEditMode.checked = !!state.ui.editMode;

    applyLevelPanelUI();
    if (state.ui.levelPanelOpen) renderLevelStylePanel();

    renderPeopleTop();

    elTree.innerHTML = "";

    const vis = visibleSet();
    const roots = childrenOf(null);

    if (!roots.length){
      const empty = document.createElement("div");
      empty.className = "empty";
      empty.innerHTML = `<div style="font-weight:800; margin-bottom:6px;">Nenhum item ainda.</div>`;
      elTree.appendChild(empty);
    } else {
      const frag = document.createDocumentFragment();
      for (const r of roots){
        if (vis && !vis.has(r.id)) continue;
        if (r.archived) continue;
        frag.appendChild(renderItem(r, 0, vis));
      }
      elTree.appendChild(frag);
    }

    renderCompleted();
    updateCounters();
  }

  function renderItem(item, depth, vis){
    const row = document.createElement("div");
    row.className = "row" + (item.completed ? " done" : "") + (item.actionsOpen ? " actionsOpen" : "");
    row.dataset.id = item.id;

    row.appendChild(makeDropZone(item.id, "before"));

    const head = document.createElement("div");
    head.className = "row-head";

    // ‚úÖ duplo clique alterna barra de a√ß√µes (exceto em inputs/bot√µes)
    head.addEventListener("dblclick", (e)=> {
      e.preventDefault();
      const t = e.target;
      if (t && (t.tagName === "INPUT" || t.tagName === "TEXTAREA" || t.tagName === "BUTTON" || t.closest("button"))) return;
      item.actionsOpen = !item.actionsOpen;
      touchItem(item);
      markDirty();
      render();
    });

    // DnD: drop em cima vira filho
    head.addEventListener("dragover", (e)=> { e.preventDefault(); head.style.outline = "2px solid color-mix(in srgb, var(--accent) 35%, transparent)"; head.style.outlineOffset="-2px"; });
    head.addEventListener("dragleave", ()=> { head.style.outline = ""; });
    head.addEventListener("drop", (e)=> {
      head.style.outline = "";
      e.preventDefault();
      const dragId = e.dataTransfer.getData("text/plain");
      if (!dragId || dragId === item.id) return;
      moveAsChild(dragId, item.id);
    });

    const indentWrap = document.createElement("div");
    indentWrap.className = "indent";
    for(let i=0;i<depth;i++){
      const pad = document.createElement("div");
      pad.className = "pad";
      indentWrap.appendChild(pad);
    }

    const handle = document.createElement("div");
    handle.className = "handle";
    handle.textContent = "‚ãÆ‚ãÆ";
    handle.draggable = true;
    handle.title = "Arraste para reorganizar";
    handle.addEventListener("dragstart", (e)=> {
      row.classList.add("dragging");
      e.dataTransfer.setData("text/plain", item.id);
      e.dataTransfer.effectAllowed = "move";
    });
    handle.addEventListener("dragend", ()=> row.classList.remove("dragging"));

    const btnExpand = document.createElement("button");
    btnExpand.className = "iconBtn";
    btnExpand.title = item.expanded ? "Colapsar (colapsa filhos tamb√©m)" : "Expandir";
    btnExpand.textContent = item.expanded ? "‚ñæ" : "‚ñ∏";
    btnExpand.addEventListener("click", ()=> {
      if (item.expanded) collapseSubtree(item.id);
      else item.expanded = true;
      touchItem(item);
      markDirty();
      render();
    });

    // ‚úÖ bot√£o de notas/detalhes fica VERDE se tiver nota ou link
    const btnDetails = document.createElement("button");
    btnDetails.className = "iconBtn" + (itemHasNotesOrLinks(item) ? " ok" : "");
    btnDetails.title = "Abrir / fechar detalhes";
    btnDetails.textContent = item.detailsOpen ? "üßæ" : "üóÇ";
    btnDetails.addEventListener("click", ()=> {
      item.detailsOpen = !item.detailsOpen;
      touchItem(item);
      markDirty();
      render();
    });

    const chkDone = document.createElement("input");
    chkDone.type = "checkbox";
    chkDone.checked = !!item.completed;
    chkDone.title = "Concluir";
    chkDone.style.transform = "scale(1.05)";
    chkDone.style.accentColor = "var(--ok)";
    chkDone.addEventListener("change", ()=> {
      item.completed = chkDone.checked;
      item.completedAt = item.completed ? nowISO() : null;
      touchItem(item);
      markDirty();
      render();
    });

    const title = document.createElement("input");
    title.className = "titleInput";
    title.placeholder = "T√≠tulo‚Ä¶";
    title.value = item.title ?? "";
    applyTitleStyleByDepth(title, depth);
    title.addEventListener("input", ()=> {
      item.title = title.value;
      touchItem(item);
      markDirty();
      updateCounters();
    });

    const dots = stalenessDots(stalenessDays(item));

    const badges = document.createElement("div");
    badges.className = "badges";

    const dt = item.milestone?.enabled ? (item.milestone.date || "") : "";
    const dateBadge = document.createElement("span");
    dateBadge.className = "badge";
    dateBadge.textContent = dt ? `üìÖ ${dt}` : "üìÖ ‚Äî";
    badges.appendChild(dateBadge);

    const peopleCount = (item.people || []).length;
    const peopleBadge = document.createElement("span");
    peopleBadge.className = "badge";
    peopleBadge.title = "Pessoas";
    peopleBadge.textContent = `üë§ ${peopleCount}`;
    badges.appendChild(peopleBadge);

    head.appendChild(indentWrap);
    head.appendChild(handle);
    head.appendChild(btnExpand);
    head.appendChild(btnDetails);
    head.appendChild(chkDone);
    head.appendChild(title);
    head.appendChild(dots);
    head.appendChild(badges);

    row.appendChild(head);

    if (item.detailsOpen) {
      const body = document.createElement("div");
      body.className = "row-body";
      body.appendChild(renderExpandedPanels(item));
      row.appendChild(body);
    }

    // ‚úÖ actions bar (aparece no duplo clique)
    const bar = document.createElement("div");
    bar.className = "actionsBar";

    const btnAddChild = icon("Ôºã", "Adicionar filho", () => {
      addItem(item.id);
      item.expanded = true;
      touchItem(item);
      markDirty();
      render();
    });
    btnAddChild.classList.add("editOnly");

    const btnArchive = icon(item.archived ? "‚Ü©Ô∏è" : "üì¶", item.archived ? "Desarquivar" : "Arquivar", () => {
      item.archived = !item.archived;
      if (item.archived) item.detailsOpen = false;
      touchItem(item);
      markDirty();
      render();
    });
    btnArchive.classList.add("editOnly");

    const btnOutdent = icon("‚óÄÔ∏é", "Desindentar", ()=> outdentItem(item.id));
    btnOutdent.classList.add("editOnly");

    const btnIndent = icon("‚ñ∂Ô∏é", "Indentar", ()=> indentItem(item.id));
    btnIndent.classList.add("editOnly");

    const mileBtn = document.createElement("button");
    mileBtn.className = "badge editOnly inline";
    mileBtn.title = "Alternar milestone";
    mileBtn.textContent = item.milestone?.enabled ? "‚è± milestone" : "‚è±";
    mileBtn.addEventListener("click", ()=> {
      item.milestone ||= { enabled:false, date:"" };
      item.milestone.enabled = !item.milestone.enabled;
      if (!item.milestone.enabled) item.milestone.date = "";
      touchItem(item);
      markDirty();
      render();
    });

    const mileDate = document.createElement("input");
    mileDate.type = "date";
    mileDate.value = item.milestone?.date || "";
    mileDate.title = "Data do milestone";
    mileDate.style.borderRadius = "999px";
    mileDate.style.border = "1px solid color-mix(in srgb, var(--muted) 22%, transparent)";
    mileDate.style.background = "color-mix(in srgb, var(--panel) 35%, transparent)";
    mileDate.style.color = "var(--text)";
    mileDate.style.padding = "4px 8px";
    mileDate.style.fontSize = "11px";
    mileDate.classList.add("editOnly","inline");
    if (!item.milestone?.enabled) mileDate.style.display = "none";
    mileDate.addEventListener("change", ()=> {
      item.milestone.date = mileDate.value;
      touchItem(item);
      markDirty();
      render();
    });

    const over = document.createElement("span");
    over.className = "badge editOnly inline " + (isOverdue(item) ? "danger" : (item.completed ? "ok" : ""));
    over.textContent = isOverdue(item) ? "‚ö† atrasado" : (item.completed ? "‚úÖ" : "üóì");
    if (!item.milestone?.enabled) over.style.display = "none";

    const btnDel = icon("üóë", "Excluir", ()=> {
      if (!confirm("Excluir este item e todos os filhos?")) return;
      deleteItem(item.id);
      markDirty();
      render();
    });
    btnDel.classList.add("editOnly");

    bar.appendChild(btnAddChild);
    bar.appendChild(btnArchive);
    bar.appendChild(btnOutdent);
    bar.appendChild(btnIndent);
    bar.appendChild(mileBtn);
    bar.appendChild(mileDate);
    bar.appendChild(over);
    bar.appendChild(spacer());
    bar.appendChild(btnDel);

    row.appendChild(bar);

    row.appendChild(makeDropZone(item.id, "after"));

    if (item.expanded) {
      const kids = childrenOf(item.id);
      const activeKids = kids.filter(k => !k.archived);
      const archivedKids = kids.filter(k => k.archived);

      if (activeKids.length){
        const childWrap = document.createElement("div");
        childWrap.style.display = "flex";
        childWrap.style.flexDirection = "column";
        childWrap.style.gap = "6px";
        childWrap.style.marginTop = "6px";
        const frag = document.createDocumentFragment();
        for (const c of activeKids){
          if (vis && !vis.has(c.id)) continue;
          frag.appendChild(renderItem(c, depth+1, vis));
        }
        childWrap.appendChild(frag);
        row.appendChild(childWrap);
      }

      if (archivedKids.length){
        const box = document.createElement("div");
        box.className = "archiveBox";

        const hdr = document.createElement("div");
        hdr.className = "archiveHdr";
        hdr.innerHTML = `${item.archiveOpen ? "‚ñæ" : "‚ñ∏"} Arquivados (${archivedKids.length})`;
        hdr.addEventListener("click", ()=> {
          item.archiveOpen = !item.archiveOpen;
          touchItem(item);
          markDirty();
          render();
        });

        box.appendChild(hdr);

        if (item.archiveOpen){
          const list = document.createElement("div");
          list.className = "archiveList";
          const fragA = document.createDocumentFragment();
          for (const c of archivedKids){
            if (vis && !vis.has(c.id)) continue;
            fragA.appendChild(renderItem(c, depth+1, vis));
          }
          list.appendChild(fragA);
          box.appendChild(list);
        }
        row.appendChild(box);
      }
    }

    return row;
  }

  function icon(txt, title, onClick){
    const b = document.createElement("button");
    b.className = "iconBtn";
    b.textContent = txt;
    b.title = title;
    b.addEventListener("click", onClick);
    return b;
  }
  function spacer(){
    const d = document.createElement("div");
    d.className = "spacer";
    return d;
  }

  // ---- Details panels ----
  function renderExpandedPanels(item){
    const wrap = document.createElement("div");
    wrap.className = "grid";

    const notes = document.createElement("div");
    notes.className = "panel";
    notes.innerHTML = `<h4>üìù Notas <small class="muted">(salva)</small></h4>`;
    const ta = document.createElement("textarea");
    ta.placeholder = "Notas‚Ä¶";
    ta.value = item.notes || "";
    ta.addEventListener("input", ()=> {
      item.notes = ta.value;
      scheduleNoteTouch(item);
    });
    notes.appendChild(ta);

    const links = document.createElement("div");
    links.className = "panel";
    links.innerHTML = `
      <h4>üîó Links <small class="muted">(CRUD)</small></h4>
      <div class="miniRow">
        <input type="text" id="lnTitle-${item.id}" placeholder="T√≠tulo" />
        <input type="url" id="lnUrl-${item.id}" placeholder="https://..." />
        <button class="btn" style="padding:7px 9px; border-radius:10px;" id="lnAdd-${item.id}">Add</button>
      </div>
      <div class="list" id="lnList-${item.id}"></div>
    `;
    const lnTitle = links.querySelector(`#lnTitle-${item.id}`);
    const lnUrl = links.querySelector(`#lnUrl-${item.id}`);
    const lnAdd = links.querySelector(`#lnAdd-${item.id}`);
    const lnList = links.querySelector(`#lnList-${item.id}`);
    item.links ||= [];

    lnAdd.addEventListener("click", ()=> {
      const t = (lnTitle.value || "").trim();
      const u = (lnUrl.value || "").trim();
      if (!t || !u) return alert("Preencha t√≠tulo e URL.");
      item.links.push({ id: uid(), title: t, url: u });
      lnTitle.value = ""; lnUrl.value = "";
      touchItem(item);
      markDirty();
      render();
    });

    renderLinkList(item, lnList);

    const people = document.createElement("div");
    people.className = "panel";
    people.innerHTML = `
      <h4>üë• Pessoas <small class="muted">(CRUD)</small></h4>
      <div class="miniRow">
        <input type="text" id="pName-${item.id}" placeholder="Nome" />
        <button class="btn" style="padding:7px 9px; border-radius:10px;" id="pAdd-${item.id}">Add</button>
        <span class="badge" title="Total">üë§ <span id="pTotal-${item.id}">0</span></span>
      </div>
      <div class="list" id="pList-${item.id}"></div>
    `;
    const pName = people.querySelector(`#pName-${item.id}`);
    const pAdd = people.querySelector(`#pAdd-${item.id}`);
    const pTotal = people.querySelector(`#pTotal-${item.id}`);
    const pList = people.querySelector(`#pList-${item.id}`);
    item.people ||= [];

    pAdd.addEventListener("click", ()=> {
      const n = (pName.value || "").trim();
      if (!n) return alert("Digite um nome.");
      item.people.push({ id: uid(), name: n });
      pName.value = "";
      touchItem(item);
      markDirty();
      render();
    });

    renderPeopleList(item, pList, pTotal);

    wrap.appendChild(notes);
    wrap.appendChild(links);
    wrap.appendChild(people);
    return wrap;
  }

  function renderLinkList(item, container){
    container.innerHTML = "";
    if (!item.links?.length){
      const d = document.createElement("div");
      d.className = "muted";
      d.style.fontSize = "11px";
      d.textContent = "Sem links.";
      container.appendChild(d);
      return;
    }
    for (const l of item.links){
      const line = document.createElement("div");
      line.className = "itemLine";
      const left = document.createElement("div");
      left.innerHTML = `<div style="font-weight:750;">${escapeHtml(l.title)}</div>
                        <div class="muted" style="font-size:11px; word-break:break-all;">
                          <a href="${escapeAttr(l.url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(l.url)}</a>
                        </div>`;
      const right = document.createElement("div");
      right.className = "right";

      const edit = icon("‚úèÔ∏è","Editar", ()=> {
        const nt = prompt("T√≠tulo:", l.title);
        if (nt === null) return;
        const nu = prompt("URL:", l.url);
        if (nu === null) return;
        l.title = nt.trim() || l.title;
        l.url = nu.trim() || l.url;
        touchItem(item);
        markDirty();
        render();
      });

      const del = icon("üóë","Remover", ()=> {
        item.links = item.links.filter(x => x.id !== l.id);
        touchItem(item);
        markDirty();
        render();
      });

      right.appendChild(edit);
      right.appendChild(del);
      line.appendChild(left);
      line.appendChild(right);
      container.appendChild(line);
    }
  }

  function renderPeopleList(item, listEl, totalEl){
    listEl.innerHTML = "";
    totalEl.textContent = String(item.people?.length || 0);

    if (!item.people?.length){
      const d = document.createElement("div");
      d.className = "muted";
      d.style.fontSize = "11px";
      d.textContent = "Sem pessoas.";
      listEl.appendChild(d);
      return;
    }
    for (const p of item.people){
      const line = document.createElement("div");
      line.className = "itemLine";
      line.innerHTML = `<span style="font-size:16px;">üë§</span>
                        <div style="font-weight:750;">${escapeHtml(p.name)}</div>`;
      const right = document.createElement("div");
      right.className = "right";

      const edit = icon("‚úèÔ∏è","Editar", ()=> {
        const nn = prompt("Nome:", p.name);
        if (nn === null) return;
        p.name = nn.trim() || p.name;
        touchItem(item);
        markDirty();
        render();
      });

      const del = icon("üóë","Remover", ()=> {
        item.people = item.people.filter(x => x.id !== p.id);
        touchItem(item);
        markDirty();
        render();
      });

      right.appendChild(edit);
      right.appendChild(del);
      line.appendChild(right);
      listEl.appendChild(line);
    }
  }

  function renderCompleted(){
    elCompleted.innerHTML = "";
    const done = state.items.filter(i => !!i.completed).sort((a,b)=>{
      const ta = new Date(a.completedAt || a.updatedAt || a.createdAt).getTime();
      const tb = new Date(b.completedAt || b.updatedAt || b.createdAt).getTime();
      return tb - ta;
    });

    elDoneHint.textContent = `(${done.length})`;

    if (!done.length){
      const d = document.createElement("div");
      d.className = "empty";
      d.style.margin = "10px";
      d.textContent = "Nada conclu√≠do ainda.";
      elCompleted.appendChild(d);
      return;
    }

    for (const it of done){
      const depth = depthOf(it);

      const row = document.createElement("div");
      row.className = "cRow";

      const indent = document.createElement("div");
      indent.className = "indent";
      for (let i=0;i<depth;i++){
        const pad = document.createElement("div");
        pad.className = "pad";
        indent.appendChild(pad);
      }

      const title = document.createElement("div");
      title.innerHTML = `<div class="cTitle">‚úÖ ${escapeHtml(it.title || "(sem t√≠tulo)")}</div>
                         <div class="cMeta">Conclu√≠do: ${formatDate(it.completedAt)} ‚Ä¢ Atualizado: ${formatDate(it.updatedAt)} ‚Ä¢ Criado: ${formatDate(it.createdAt)}</div>`;

      const dots = stalenessDots(stalenessDays(it));

      row.appendChild(indent);
      row.appendChild(title);
      row.appendChild(dots);
      elCompleted.appendChild(row);
    }
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function escapeAttr(s){ return escapeHtml(s); }

  // ---- DnD drop zones ----
  function makeDropZone(targetItemId, where){
    const z = document.createElement("div");
    z.className = "dropZone";
    z.dataset.target = targetItemId;
    z.dataset.where = where;

    z.addEventListener("dragover", (e)=> { e.preventDefault(); z.classList.add("active"); });
    z.addEventListener("dragleave", ()=> z.classList.remove("active"));
    z.addEventListener("drop", (e)=> {
      e.preventDefault();
      z.classList.remove("active");
      const dragId = e.dataTransfer.getData("text/plain");
      if (!dragId || dragId === targetItemId) return;
      moveAsSibling(dragId, targetItemId, where);
    });
    return z;
  }

  function moveAsSibling(dragId, targetId, where){
    const drag = getItem(dragId);
    const target = getItem(targetId);
    if (!drag || !target) return;

    const newParentId = target.parentId ?? null;
    if (wouldCreateCycle(dragId, newParentId)) return alert("Movimento inv√°lido (ciclo).");

    const oldParentId = drag.parentId ?? null;
    drag.parentId = newParentId;

    let sibs = childrenOf(newParentId).filter(x => x.id !== dragId);
    const tIndex = sibs.findIndex(x => x.id === targetId);
    const insertAt = Math.max(0, Math.min((where === "before" ? tIndex : tIndex+1), sibs.length));

    sibs.splice(insertAt, 0, drag);
    sibs.forEach((x, idx) => x.order = idx);

    normalizeOrders(oldParentId);

    touchItem(drag);
    markDirty();
    render();
  }

  function moveAsChild(dragId, newParentId){
    const drag = getItem(dragId);
    const parent = getItem(newParentId);
    if (!drag || !parent) return;

    if (wouldCreateCycle(dragId, newParentId)) return alert("Movimento inv√°lido (ciclo).");

    const oldParentId = drag.parentId ?? null;

    drag.parentId = newParentId;
    drag.order = nextOrder(newParentId);

    normalizeOrders(oldParentId);

    parent.expanded = true;
    touchItem(drag);
    touchItem(parent);
    markDirty();
    render();
  }

  // ---- indent / outdent ----
  function indentItem(id){
    const item = getItem(id);
    if (!item) return;
    const sibs = siblingsOf(item);
    const idx = sibs.findIndex(x => x.id === id);
    if (idx <= 0) return;

    const prev = sibs[idx-1];
    if (wouldCreateCycle(id, prev.id)) return alert("Movimento inv√°lido (ciclo).");

    const oldParentId = item.parentId ?? null;
    item.parentId = prev.id;
    item.order = nextOrder(prev.id);
    prev.expanded = true;

    normalizeOrders(oldParentId);

    touchItem(item);
    touchItem(prev);
    markDirty();
    render();
  }

  function outdentItem(id){
    const item = getItem(id);
    if (!item || item.parentId == null) return;

    const parent = getItem(item.parentId);
    if (!parent) return;

    const grand = parent.parentId ?? null;
    if (wouldCreateCycle(id, grand)) return alert("Movimento inv√°lido (ciclo).");

    const oldParentId = item.parentId;
    item.parentId = grand;

    let sibs = childrenOf(grand).filter(x => x.id !== id);
    const pIndex = sibs.findIndex(x => x.id === parent.id);
    const insertAt = Math.max(0, Math.min(pIndex+1, sibs.length));

    sibs.splice(insertAt, 0, item);
    sibs.forEach((x, idx)=> x.order = idx);

    normalizeOrders(oldParentId);

    touchItem(item);
    markDirty();
    render();
  }

  // ---- CRUD items ----
  function addItem(parentId){
    const t = nowISO();
    const newItem = {
      id: uid(),
      title: "",
      parentId: parentId ?? null,
      order: nextOrder(parentId ?? null),
      expanded: false,
      detailsOpen: false,
      actionsOpen: false,      // ‚úÖ default fechado
      completed: false,
      milestone: { enabled:false, date:"" },
      links: [],
      notes: "",
      people: [],
      createdAt: t,
      updatedAt: t,
      completedAt: null,
      archived: false,
      archiveOpen: false
    };
    state.items.push(newItem);
    markDirty();
    render();
    setTimeout(() => {
      const row = document.querySelector(`.row[data-id="${CSS.escape(newItem.id)}"]`);
      row?.querySelector(".titleInput")?.focus();
    }, 40);
  }

  function deleteItem(id){
    const ids = new Set(subtreeIds(id));
    const victim = getItem(id);
    const parentId = victim?.parentId ?? null;

    state.items = state.items.filter(x => !ids.has(x.id));
    normalizeOrders(parentId);
  }

  // ---- backup/import ----
  function download(filename, text){
    const blob = new Blob([text], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }
  function doBackup(){
    const payload = { exportedAt: nowISO(), version: 1, state };
    download(`backup-tree-milestones-${new Date().toISOString().slice(0,19).replaceAll(":","")}.json`,
             JSON.stringify(payload, null, 2));
  }
  function doImportFile(file){
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const raw = String(reader.result || "");
        const parsed = JSON.parse(raw);
        const incoming = parsed?.state?.items ? parsed.state : parsed;
        if (!incoming || !Array.isArray(incoming.items)) throw new Error("Formato inv√°lido");

        incoming.ui ||= {};
        if (typeof incoming.ui.filterMilestones !== "boolean") incoming.ui.filterMilestones = false;
        if (!incoming.ui.theme) incoming.ui.theme = "dark";
        if (typeof incoming.ui.editMode !== "boolean") incoming.ui.editMode = false;
        incoming.ui.levelStyles ||= defaultLevelStyles();
        if (typeof incoming.ui.levelPanelOpen !== "boolean") incoming.ui.levelPanelOpen = false;
        incoming.ui.peopleTop ||= { open:true, active:"" };

        const tNow = nowISO();
        for (const it of incoming.items){
          it.id ||= uid();
          it.title ||= "";
          it.parentId = (it.parentId === undefined) ? null : it.parentId;
          it.order = (typeof it.order === "number") ? it.order : 0;

          it.expanded = !!it.expanded;
          it.detailsOpen = !!it.detailsOpen;
          if (typeof it.actionsOpen !== "boolean") it.actionsOpen = false;

          it.completed = !!it.completed;
          it.milestone ||= { enabled:false, date:"" };
          it.milestone.enabled = !!it.milestone.enabled;
          it.milestone.date ||= "";
          it.links ||= [];
          it.notes ||= "";
          it.people ||= [];

          it.createdAt ||= tNow;
          it.updatedAt ||= it.createdAt;
          it.completedAt = it.completed ? (it.completedAt || it.updatedAt || tNow) : null;

          it.archived = !!it.archived;
          if (typeof it.archiveOpen !== "boolean") it.archiveOpen = false;
        }

        const ids = new Set(incoming.items.map(x=>x.id));
        for (const it of incoming.items){
          if (it.parentId != null && !ids.has(it.parentId)) it.parentId = null;
        }

        state = incoming;
        markDirty();
        applyTheme();
        applyLevelPanelUI();
        render();
        alert("Import conclu√≠do. Clique em Salvar agora para persistir.");
      }catch(e){
        console.error(e);
        alert("Falha ao importar: arquivo inv√°lido.");
      }
    };
    reader.readAsText(file);
  }

  // ---- counters ----
  function updateCounters(){
    elCountItems.textContent = String(state.items.length);
    elCountDone.textContent = String(state.items.filter(i => !!i.completed).length);
    elCountOverdue.textContent = String(state.items.filter(isOverdue).length);
  }

  // ---- UI events ----
  document.getElementById("addRootBtn").addEventListener("click", ()=> addItem(null));
  document.getElementById("backupBtn").addEventListener("click", doBackup);
  document.getElementById("importBtn").addEventListener("click", ()=> document.getElementById("importFile").click());
  document.getElementById("importFile").addEventListener("change", (e)=> {
    const f = e.target.files?.[0];
    if (f) doImportFile(f);
    e.target.value = "";
  });

  // ---- init ----
  applyTheme();
  applyLevelPanelUI();
  render();

  if (!lsOk){
    setStatus("bad", "‚õî LocalStorage bloqueado");
    alert("LocalStorage est√° bloqueado nesse contexto.\n\nEvite modo privado e previews em iframe.\nPrefer√≠vel: abrir com Live Server / http://localhost.");
  } else {
    setStatus("ok", "‚úÖ Carregado do dispositivo");
  }
})();
</script>
</body>
</html>
