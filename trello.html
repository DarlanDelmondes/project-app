<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Swimlane Board ‚Äî LocalStorage</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .dragging { opacity: 0.5; }
    .drop-target { outline: 2px dashed rgba(0,0,0,0.25); outline-offset: -6px; }

    .age-1h { box-shadow: 0 0 0 3px rgba(34,197,94,0.8) inset; }
    .age-4h { box-shadow: 0 0 0 3px rgba(59,130,246,0.8) inset; }
    .age-24h { box-shadow: 0 0 0 3px rgba(234,179,8,0.9) inset; }
    .age-7d { box-shadow: 0 0 0 3px rgba(244,63,94,0.85) inset; }
    .age-old { box-shadow: 0 0 0 2px rgba(107,114,128,0.45) inset; }

    .dimmed { opacity: 0.25; filter: grayscale(0.7); }
    .glow { animation: glow 1.3s ease-in-out infinite alternate; }
    @keyframes glow { from { box-shadow: 0 0 0 3px rgba(255,255,255,0) inset, 0 0 0 rgba(0,0,0,0);} to { box-shadow: 0 0 0 3px rgba(99,102,241,0.55) inset, 0 8px 24px rgba(99,102,241,0.25);} }

    .thin-scroll::-webkit-scrollbar{height:8px;width:8px} .thin-scroll::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:9999px}

    /* Night mode */
    .dark body { background-color: #0f172a; color: #e2e8f0; }
    .dark .bg-white { background-color: #1e293b !important; color: #e2e8f0; }
    .dark .bg-slate-50 { background-color: #1e293b !important; }
    .dark .text-slate-800 { color: #e2e8f0; }
    .dark .border { border-color: #334155 !important; }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <header class="sticky top-0 z-40 border-b bg-white/90 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap items-center gap-3">
      <h1 class="text-xl font-bold tracking-tight">Swimlane Board</h1>
      <button id="toggleDark" class="px-3 py-1.5 rounded-lg border text-sm">üåô/‚òÄÔ∏è</button>
      <div class="ml-auto flex flex-wrap items-center gap-2">
        <div class="flex items-center gap-2" role="group">
          <button data-filter="1h" class="filter-btn px-3 py-1.5 rounded-full border text-sm">‚â§ 1h</button>
          <button data-filter="4h" class="filter-btn px-3 py-1.5 rounded-full border text-sm">‚â§ 4h</button>
          <button data-filter="24h" class="filter-btn px-3 py-1.5 rounded-full border text-sm">‚â§ 24h</button>
          <button data-filter="7d" class="filter-btn px-3 py-1.5 rounded-full border text-sm">‚â§ 1 semana</button>
          <button id="clearFilter" class="px-3 py-1.5 rounded-full border text-sm">Limpar filtro</button>
        </div>
        <button id="newProject" class="px-3 py-1.5 rounded-lg bg-indigo-600 text-white text-sm">Novo projeto</button>
        <button id="exportBtn" class="px-3 py-1.5 rounded-lg border text-sm">Exportar</button>
        <label class="px-3 py-1.5 rounded-lg border text-sm cursor-pointer">Importar<input id="importFile" type="file" accept="application/json" class="hidden" /></label>
      </div>
    </div>
    <div id="projectsOverview" class="max-w-7xl mx-auto px-4 pb-3 flex gap-2 flex-wrap"></div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-8" id="boardRoot"></main>

  <template id="overviewTpl">
    <div class="overview-item px-3 py-2 rounded-lg border shadow-sm"></div>
  </template>

  <template id="projectTpl">
    <section class="swimlane bg-white rounded-2xl border shadow-sm">
      <header class="px-4 py-3 border-b flex items-center gap-3">
        <h2 class="lane-title text-lg font-semibold"></h2>
        <button class="rename-lane text-xs px-2 py-1 rounded border">Renomear</button>
        <button class="delete-lane text-xs px-2 py-1 rounded border border-rose-300 text-rose-700 ml-1">Excluir</button>
        <div class="ml-auto flex items-center gap-2">
          <button class="add-column px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm">+ Coluna</button>
        </div>
      </header>
      <div class="columns flex gap-4 overflow-auto thin-scroll p-4"></div>
    </section>
  </template>

  <template id="columnTpl">
    <div class="column w-72 shrink-0 bg-slate-50 rounded-xl border p-3 flex flex-col" draggable="false">
      <div class="flex items-center gap-2 mb-2">
        <h3 class="col-title font-semibold"></h3>
        <button class="rename-col text-xs px-2 py-0.5 rounded border">Renomear</button>
        <button class="delete-col text-xs px-2 py-0.5 rounded border border-rose-300 text-rose-700">Excluir</button>
      </div>
      <div class="cards space-y-2 min-h-[40px] flex-1" data-dropzone></div>
      <button class="add-card mt-3 px-3 py-2 rounded-lg bg-white border hover:bg-slate-100">+ Card</button>
    </div>
  </template>

  <template id="cardTpl">
    <article class="card card-age rounded-lg border bg-white p-3 shadow-sm cursor-grab active:cursor-grabbing" draggable="true">
      <div class="flex items-center gap-2">
        <h4 class="card-title font-medium flex-1 whitespace-pre-wrap"></h4>
        <button class="edit-card text-xs px-2 py-0.5 rounded border">Editar</button>
      </div>
      <p class="card-desc text-sm text-slate-600 mt-1 whitespace-pre-wrap"></p>
      <div class="mt-2 text-[11px] text-slate-500 flex items-center justify-between">
        <span class="last-activity">‚Äî</span>
      </div>
    </article>
  </template>

  <script>
  const STORAGE_KEY = 'swimlane.board.v1';
  let state = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{"projects":[]}');
  const ms = { h: 3600000, d: 86400000 };
  const FILTER_WINDOWS = { '1h': ms.h, '4h': 4*ms.h, '24h': 24*ms.h, '7d': 7*ms.d };
  let activeFilter = null;

  function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

  function projectLastActivity(project) {
    let last = 0;
    project.columns.forEach(c => c.cards.forEach(card => {
      const t = new Date(card.lastActivity).getTime();
      if (t > last) last = t;
    }));
    return last ? new Date(last).toISOString() : project.createdAt;
  }

  function ageClass(iso) {
    const diff = Date.now() - new Date(iso).getTime();
    if (diff <= FILTER_WINDOWS['1h']) return 'age-1h';
    if (diff <= FILTER_WINDOWS['4h']) return 'age-4h';
    if (diff <= FILTER_WINDOWS['24h']) return 'age-24h';
    if (diff <= FILTER_WINDOWS['7d']) return 'age-7d';
    return 'age-old';
  }

  function shortTimeAgo(iso) {
    const dt = new Date(iso);
    const diff = Date.now() - dt.getTime();
    const mins = Math.floor(diff/60000);
    if (mins < 1) return 'agora';
    if (mins < 60) return mins + ' min';
    const hrs = Math.floor(mins/60);
    if (hrs < 24) return hrs + ' h';
    const days = Math.floor(hrs/24);
    return days + ' d';
  }

  function renderOverview() {
    const wrap = document.getElementById('projectsOverview');
    wrap.innerHTML = '';
    const tpl = document.getElementById('overviewTpl');
    state.projects.forEach(p => {
      const item = tpl.content.firstElementChild.cloneNode(true);
      const last = projectLastActivity(p);
      item.textContent = p.title + ' (' + shortTimeAgo(last) + ')';
      item.classList.add(ageClass(last));
      if (activeFilter) {
        const win = FILTER_WINDOWS[activeFilter];
        const recent = Date.now() - new Date(last).getTime() <= win;
        if (!recent) item.classList.add('dimmed'); else item.classList.add('glow');
      }
      wrap.appendChild(item);
    });
  }

  function render() {
    renderOverview();
    const boardRoot = document.getElementById('boardRoot');
    boardRoot.innerHTML = '';
    state.projects.forEach(project => {
      const sec = document.getElementById('projectTpl').content.firstElementChild.cloneNode(true);
      sec.querySelector('.lane-title').textContent = project.title;
      sec.querySelector('.rename-lane').onclick = () => {
        const v = prompt('Novo t√≠tulo do projeto:', project.title);
        if (v) { project.title = v; saveState(); render(); }
      };
      sec.querySelector('.delete-lane').onclick = () => {
        if (confirm('Excluir projeto?')) { state.projects = state.projects.filter(p=>p.id!==project.id); saveState(); render(); }
      };
      sec.querySelector('.add-column').onclick = () => {
        project.columns.push({ id: uid(), title: 'Nova coluna', cards: [] });
        saveState(); render();
      };
      const colsWrap = sec.querySelector('.columns');
      project.columns.forEach(col => {
        const colEl = document.getElementById('columnTpl').content.firstElementChild.cloneNode(true);
        colEl.querySelector('.col-title').textContent = col.title;
        colEl.querySelector('.rename-col').onclick = () => { const v = prompt('Novo t√≠tulo:', col.title); if(v){col.title=v; saveState(); render();}};
        colEl.querySelector('.delete-col').onclick = () => { if(confirm('Excluir coluna?')){ project.columns = project.columns.filter(c=>c.id!==col.id); saveState(); render();}};
        colEl.querySelector('.add-card').onclick = () => { col.cards.push({id:uid(), title:'Novo card', description:'', createdAt:nowISO(), lastActivity:nowISO(), history:[]}); saveState(); render(); };
        const cardsWrap = colEl.querySelector('.cards');
        enableDropzone(cardsWrap, project.id, col.id);
        col.cards.forEach(card=> cardsWrap.appendChild(createCardElement(card, project.id, col.id)));
        colsWrap.appendChild(colEl);
      });
      boardRoot.appendChild(sec);
    });
  }

  function uid(){ return Math.random().toString(36).slice(2,9); }
  function nowISO(){ return new Date().toISOString(); }

  function createCardElement(card, projectId, colId){
    const el = document.getElementById('cardTpl').content.firstElementChild.cloneNode(true);
    el.dataset.cardId = card.id;
    el.querySelector('.card-title').textContent = card.title;
    el.querySelector('.card-desc').textContent = card.description;
    el.querySelector('.last-activity').textContent = 'atualizado ' + shortTimeAgo(card.lastActivity);
    el.classList.add(ageClass(card.lastActivity));
    el.querySelector('.edit-card').onclick = () => {
      const t = prompt('T√≠tulo:', card.title);
      const d = prompt('Descri√ß√£o:', card.description);
      if(d!==card.description){ card.history.unshift({ts:nowISO(), type:'edit', prev:card.description, next:d}); }
      card.title=t; card.description=d; card.lastActivity=nowISO(); saveState(); render();
    };
    el.draggable = true;
    el.ondragstart = e => { e.dataTransfer.setData('text/plain', card.id); };
    return el;
  }

  function enableDropzone(zoneEl, projectId, colId){
    zoneEl.ondragover = e => e.preventDefault();
    zoneEl.ondrop = e => { e.preventDefault(); const cardId = e.dataTransfer.getData('text/plain'); moveCard(cardId, projectId, colId); };
  }

  function moveCard(cardId, projectId, colId){
    for(const p of state.projects){
      for(const c of p.columns){
        const idx = c.cards.findIndex(cd=>cd.id===cardId);
        if(idx!==-1){
          const card = c.cards.splice(idx,1)[0];
          const proj = state.projects.find(pp=>pp.id===projectId);
          const col = proj.columns.find(cc=>cc.id===colId);
          card.history.unshift({ts:nowISO(), type:'move'});
          card.lastActivity=nowISO();
          col.cards.push(card);
          saveState(); render(); return;
        }
      }
    }
  }

  document.querySelectorAll('.filter-btn').forEach(btn=> btn.onclick=()=>{ activeFilter=btn.dataset.filter; render(); });
  document.getElementById('clearFilter').onclick=()=>{ activeFilter=null; render(); };

  document.getElementById('newProject').onclick=()=>{ state.projects.push({id:uid(), title:'Novo projeto', createdAt:nowISO(), columns:[]}); saveState(); render(); };

  document.getElementById('toggleDark').onclick=()=> document.documentElement.classList.toggle('dark');

  document.getElementById('exportBtn').onclick=()=>{ const blob=new Blob([JSON.stringify(state)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='swimlane.json'; a.click(); };
  document.getElementById('importFile').onchange=e=>{ const f=e.target.files[0]; const r=new FileReader(); r.onload=()=>{ state=JSON.parse(r.result); saveState(); render(); }; r.readAsText(f); };

  if(!state.projects.length){ state.projects.push({id:uid(), title:'Exemplo', createdAt:nowISO(), columns:[{id:uid(), title:'A Fazer', cards:[]},{id:uid(), title:'Fazendo', cards:[]},{id:uid(), title:'Feito', cards:[]} ]}); saveState(); }

  render();
  </script>
</body>
</html>
